<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Members — FormFactor Racing</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="styles.css">
  <style>
    .gate { max-width: 520px; margin: 40px auto; padding: 16px; border:1px solid #e2e8f0; border-radius:12px; }
    .hidden { display:none; }
    .ok { color:#16a34a; font-weight:700; }
    .err { color:#dc2626; font-weight:700; }
    .input { width:100%; padding:10px 12px; border:1px solid #cbd5e1; border-radius:10px; }
  </style>
</head>
<body>
<header class="header">
  <div class="container nav">
    <div class="brand">
      <img src="formfactor_logo_under512kb.jpg" alt="FormFactor Racing logo" width="36" height="36" style="border-radius:8px;object-fit:cover">
      <span>FormFactor Racing</span>
    </div>
    <nav class="menu"><a href="/">Home</a></nav>
  </div>
</header>

<section class="container">
  <h1>Members Area</h1>

  <!-- Gate -->
  <div id="gate" class="gate">
    <p>Enter your access code to view today’s tips:</p>
    <form id="codeForm">
      <input class="input" id="codeInput" placeholder="e.g. FFR-DAY" required>
      <div style="margin-top:10px">
        <button class="btn primary" type="submit">Unlock</button>
      </div>
    </form>
    <p id="msg" class="tiny"></p>
    <p class="tiny">If you just purchased, your access was also saved automatically — try refreshing this page.</p>
  </div>

  <!-- Content -->
  <div id="content" class="hidden">
    <h2>Today’s Full Card</h2>
    <p class="tiny ok">Access granted. Enjoy the stats-first selections.</p>
  </div>
</section>

<footer class="site-footer">
  <div class="container">
    <p>© 2025 FormFactor Racing | ABN 37 375 806 506 | Secure payments processed by <a href="https://stripe.com" target="_blank">Stripe</a></p>
    <p class="tiny">Gamble responsibly — 1800 858 858 • <a href="https://www.gamblinghelponline.org.au" target="_blank">gamblinghelponline.org.au</a></p>
  </div>
</footer>

<script>
(function () {
  // Valid codes per plan
  const VALID = { 'FFR-DAY':'day', 'FFR-WKD':'weekend', 'FFR-MONTH':'monthly' };

  const gate = document.getElementById('gate');
  const content = document.getElementById('content');
  const msg = document.getElementById('msg');

  function hasValidEntitlement() {
    try {
      const raw = localStorage.getItem('ffr_entitlement');
      if (!raw) return false;
      const { plan, code, until } = JSON.parse(raw);
      const okCode = VALID[code] && VALID[code] === plan;
      return okCode && until && Date.now() < Number(until);
    } catch { return false; }
  }

  function unlock() {
    gate.classList.add('hidden');
    content.classList.remove('hidden');
  }

  // Auto-unlock if entitlement exists
  if (hasValidEntitlement()) unlock();

  // Manual code entry
  document.getElementById('codeForm').addEventListener('submit', (e) => {
    e.preventDefault();
    const code = document.getElementById('codeInput').value.trim().toUpperCase();
    const plan = VALID[code];
    if (!plan) {
      msg.textContent = 'Invalid code. Check your purchase email or thanks page.';
      msg.className = 'tiny err';
      return;
    }
    const EXPIRY_HRS = { day: 24, weekend: 72, monthly: 31*24 };
    const until = Date.now() + (EXPIRY_HRS[plan] || 24) * 3600 * 1000;
    localStorage.setItem('ffr_entitlement', JSON.stringify({ plan, code, until }));
    msg.textContent = 'Unlocked!';
    msg.className = 'tiny ok';
    setTimeout(unlock, 400);
  });

  // Load tips JSON when unlocked
  async function loadTips() {
    try {
      const res = await fetch('/picks.json', { cache: 'no-store' });
      if (!res.ok) throw new Error('Failed to load tips');
      const data = await res.json();

      const container = document.getElementById('content');

      // Header card
      const h = document.createElement('div');
      h.className = 'card';
      h.style.marginTop = '12px';
      h.innerHTML = `
        <h2>${data.headline || 'Today’s Tips'}</h2>
        <p class="tiny">Meeting date: ${data.date || '—'}</p>
        ${data.notes ? `<p><strong>Notes:</strong> ${data.notes}</p>` : ''}`;
      container.appendChild(h);

      // Meetings → Races
      (data.meetings || []).forEach(meet => {
        const m = document.createElement('div');
        m.className = 'card';
        m.style.marginTop = '12px';
        m.innerHTML = `<h3>${meet.track} (${meet.state})</h3>`;
        const ul = document.createElement('ul');
        ul.style.marginLeft = '18px';
        (meet.races || []).forEach(r => {
          const li = document.createElement('li');
          li.innerHTML =
            `<strong>R${r.number}:</strong> ${r.top_pick} — <em>${'★'.repeat(r.confidence || 1)}</em><br/>
             <span class="tiny">${r.reason || ''}</span>`;
          ul.appendChild(li);
        });
        m.appendChild(ul);
        container.appendChild(m);
      });
    } catch (e) {
      console.error(e);
      const container = document.getElementById('content');
      const err = document.createElement('p');
      err.className = 'tiny err';
      err.textContent = 'Could not load tips. Try refreshing.';
      container.appendChild(err);
    }
  }

  if (hasValidEntitlement()) loadTips();
  document.addEventListener('visibilitychange', () => {
    if (!document.hidden && hasValidEntitlement() && !document.getElementById('content').dataset.loaded) {
      document.getElementById('content').dataset.loaded = '1';
      loadTips();
    }
  });
})();
</script>
</body>
</html>
