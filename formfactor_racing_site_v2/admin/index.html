<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>FormFactor Racing — Admin</title>
  <style>
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .wrap{min-height:100%;display:flex;align-items:center;justify-content:center;padding:24px}
    .card{border:1px solid #e2e8f0;border-radius:12px;padding:20px;max-width:680px;width:100%;box-shadow:0 6px 18px rgba(2,8,23,.06)}
    h2{margin:0 0 6px 0}
    .muted{font-size:12px;color:#64748b;margin-top:8px}
    .row{display:flex;gap:10px;margin-top:14px;flex-wrap:wrap}
    button{padding:10px 12px;border:1px solid #e2e8f0;border-radius:10px;background:#fff;cursor:pointer}
    .err{color:#b91c1c;margin-top:10px;white-space:pre-wrap}
  </style>

  <!-- Load the Identity widget from YOUR site (no CDN) -->
  <script src="/.netlify/identity/widget"></script>

  <script>
    // ---- INLINE CMS CONFIG (no config.yml needed) ----
    window.CMS_MANUAL_INIT = true;
    const CMS_CONFIG = {
      backend: { name: "git-gateway", branch: "main" },
      media_folder: "static/uploads",
      public_folder: "/static/uploads",
      publish_mode: "editorial_workflow",
      collections: [
        {
          label: "Tips",
          name: "tips",
          files: [
            {
              label: "Race Day Tips",
              name: "picks",
              file: "/picks.json",
              format: "json",
              fields: [
                { label: "Meeting Date (AET)", name: "date", widget: "datetime", format: "YYYY-MM-DD", time_format: false },
                { label: "Headline", name: "headline", widget: "string", hint: "Shown at top of members page" },
                {
                  label: "Meetings", name: "meetings", widget: "list",
                  summary: "{{fields.track}} ({{fields.state}})",
                  fields: [
                    { label: "Track", name: "track", widget: "string" },
                    { label: "State", name: "state", widget: "string" },
                    {
                      label: "Races", name: "races", widget: "list",
                      summary: "R{{fields.number}}: {{fields.top_pick}}",
                      fields: [
                        { label: "Race #", name: "number", widget: "number", value_type: "int", min: 1 },
                        { label: "Top Pick", name: "top_pick", widget: "string" },
                        { label: "Confidence (1–5)", name: "confidence", widget: "number", value_type: "int", min: 1, max: 5 },
                        { label: "Reason (short)", name: "reason", widget: "text" }
                      ]
                    }
                  ]
                },
                { label: "Notes", name: "notes", widget: "text", hint: "Scratchings, track downgrades, staking notes" }
              ]
            }
          ]
        }
      ]
    };

    function showError(msg){
      const el = document.getElementById('err');
      if (el) el.textContent = msg;
      console.error(msg);
    }

    function bootCMS(){
      try{
        if (!window.CMS){ return showError('CMS script not loaded yet. Try clicking “Start CMS” again in a second.'); }
        CMS.init({ config: CMS_CONFIG });
        document.getElementById('shell').style.display = 'none';
      }catch(e){ showError('CMS failed to init: ' + String(e)); }
    }

    function initIdentity(){
      if (!window.netlifyIdentity){
        showError('Identity widget failed to load. If you use an ad/script blocker, allow this site and refresh.');
        return;
      }
      // Init the widget
      netlifyIdentity.init();

      // Buttons
      const btnSignup = document.getElementById('btnSignup');
      const btnLogin  = document.getElementById('btnLogin');
      const btnStart  = document.getElementById('btnStart');

      if (btnSignup) btnSignup.onclick = () => netlifyIdentity.open('signup');
      if (btnLogin)  btnLogin.onclick  = () => netlifyIdentity.open('login');
      if (btnStart)  btnStart.onclick  = bootCMS;

      // If already logged in, start CMS automatically
      netlifyIdentity.on('init', (user) => { if (user) bootCMS(); });
      netlifyIdentity.on('login', () => bootCMS());
      netlifyIdentity.on('logout', () => location.reload());
    }

    // Kick everything off after load
    window.addEventListener('load', () => {
      initIdentity();
      // If CMS script lags, try auto-boot after a moment if logged in
      setTimeout(() => {
        if (window.netlifyIdentity && netlifyIdentity.currentUser()) bootCMS();
      }, 600);
    });
  </script>
</head>
<body>
  <!-- Simple launcher UI (visible until CMS takes over) -->
  <div id="shell" class="wrap">
    <div class="card">
      <h2>FormFactor Racing — Admin</h2>
      <p>Use the buttons below to log in or sign up. After login, click <em>Start CMS</em> if it doesn’t launch automatically.</p>
      <div class="row">
        <button id="btnSignup" type="button">Sign up</button>
        <button id="btnLogin"  type="button">Login</button>
        <button id="btnStart"  type="button">Start CMS</button>
      </div>
      <p class="muted">Netlify settings required: Identity <strong>enabled</strong> (Registration: Open for first login), and Git Gateway <strong>enabled</strong>.</p>
      <pre id="err" class="err"></pre>
    </div>
  </div>

  <!-- Decap CMS (admin app) -->
  <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
  <!-- Fallback CDN if unpkg is blocked -->
  <script>
    window.addEventListener('error', function(ev){
      if ((ev.filename || '').includes('decap-cms') && !window.CMS) {
        var s=document.createElement('script');
        s.src='https://cdn.jsdelivr.net/npm/decap-cms@3/dist/decap-cms.js';
        document.head.appendChild(s);
      }
    }, true);
  </script>
</body>
</html>

