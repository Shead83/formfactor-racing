<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>FormFactor Racing Admin</title>
  <style>
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .wrap{min-height:100%;display:flex;align-items:center;justify-content:center;padding:24px}
    .card{border:1px solid #e2e8f0;border-radius:12px;padding:20px;max-width:640px;width:100%;box-shadow:0 6px 18px rgba(2,8,23,.06)}
    .muted{font-size:12px;color:#64748b;margin-top:8px}
    .row{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
    button{padding:10px 12px;border:1px solid #e2e8f0;border-radius:10px;background:#fff;cursor:pointer}
    .err{color:#b91c1c;margin-top:8px;white-space:pre-wrap}
  </style>

  <!-- Load Identity FIRST (no defer) to avoid race conditions -->
  <script src="https://unpkg.com/netlify-identity-widget@1.9.2/build/netlify-identity-widget.min.js"></script>

  <script>
    // Inline CMS config so we don't fetch config.yml
    window.CMS_MANUAL_INIT = true;
    const CMS_CONFIG = {
      backend: { name: "git-gateway", branch: "main" },
      media_folder: "static/uploads",
      public_folder: "/static/uploads",
      publish_mode: "editorial_workflow",
      collections: [
        {
          label: "Tips",
          name: "tips",
          files: [
            {
              label: "Race Day Tips",
              name: "picks",
              file: "picks.json",
              format: "json",
              fields: [
                { label: "Meeting Date (AET)", name: "date", widget: "datetime", format: "YYYY-MM-DD", time_format: false },
                { label: "Headline", name: "headline", widget: "string" },
                {
                  label: "Meetings",
                  name: "meetings",
                  widget: "list",
                  summary: "{{fields.track}} ({{fields.state}})",
                  fields: [
                    { label: "Track", name: "track", widget: "string" },
                    { label: "State", name: "state", widget: "string" },
                    {
                      label: "Races",
                      name: "races",
                      widget: "list",
                      summary: "R{{fields.number}}: {{fields.top_pick}}",
                      fields: [
                        { label: "Race #", name: "number", widget: "number", value_type: "int", min: 1 },
                        { label: "Top Pick", name: "top_pick", widget: "string" },
                        { label: "Confidence (1–5)", name: "confidence", widget: "number", value_type: "int", min: 1, max: 5 },
                        { label: "Reason (short)", name: "reason", widget: "text" }
                      ]
                    }
                  ]
                },
                { label: "Notes", name: "notes", widget: "text" }
              ]
            }
          ]
        }
      ]
    };

    function showError(msg) {
      const el = document.getElementById('err');
      if (el) el.textContent = msg;
      console.error(msg);
    }

    function initIdentityControls() {
      if (!window.netlifyIdentity) {
        showError('Identity widget failed to load. Disable ad/script blockers and refresh.');
        return;
      }
      // Ensure widget is initialized
      netlifyIdentity.init();

      // Wire buttons
      const btnSignup = document.getElementById('btnSignup');
      const btnLogin  = document.getElementById('btnLogin');
      if (btnSignup) btnSignup.onclick = () => netlifyIdentity.open('signup');
      if (btnLogin)  btnLogin.onclick  = () => netlifyIdentity.open('login');

      // Auto-open login if user not present (keeps it simple)
      netlifyIdentity.on('init', (user) => {
        if (!user) {
          // don't auto-open signup; user can choose
        }
      });

      // When user logs in, boot CMS
      netlifyIdentity.on('login', () => {
        bootCMS();
      });
      netlifyIdentity.on('logout', () => location.reload());
    }

    function bootCMS() {
      try {
        if (!window.CMS) {
          showError('CMS script not loaded yet. Wait a second and click "Start CMS" again.');
          return;
        }
        CMS.init({ config: CMS_CONFIG });
        document.getElementById('shell').style.display = 'none'; // hide launcher UI
      } catch (e) {
        showError('CMS failed to init: ' + String(e));
      }
    }

    // Expose a manual start in case login already happened
    function startIfLoggedIn() {
      if (window.netlifyIdentity && netlifyIdentity.currentUser()) {
        bootCMS();
      }
    }

    window.addEventListener('load', () => {
      initIdentityControls();
      // Give the CMS script time to load; check after a moment
      setTimeout(startIfLoggedIn, 600);
    });
  </script>
</head>
<body>
  <!-- Simple launcher UI -->
  <div id="shell" class="wrap">
    <div class="card">
      <h2>FormFactor Racing — Admin</h2>
      <p>Use the buttons below to log in or sign up. After login, click <em>Start CMS</em> if it doesn’t launch automatically.</p>
      <div class="row">
        <button id="btnSignup">Sign up</button>
        <button id="btnLogin">Login</button>
        <button id="btnStart" onclick="bootCMS()">Start CMS</button>
      </div>
      <p class="muted">Identity must be enabled (Registration: Open) and Git Gateway enabled in Netlify.</p>
      <pre id="err" class="err"></pre>
    </div>
  </div>

  <!-- Decap CMS (admin app) -->
  <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
  <!-- Fallback CDN if unpkg is blocked -->
  <script>
    window.addEventListener('error', function(ev){
      if ((ev.filename || '').includes('decap-cms') && !window.CMS) {
        var s=document.createElement('script');
        s.src='https://cdn.jsdelivr.net/npm/decap-cms@3/dist/decap-cms.js';
        document.head.appendChild(s);
      }
    }, true);
  </script>
</body>
</html>

